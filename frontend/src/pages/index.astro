---
import Layout from '../layouts/Layout.astro';
import Modal from '../components/Modal.astro';
import MessageBanner from '../components/MessageBanner.astro';
import TabNavigation from '../components/TabNavigation.astro';
import SubmitVotesTab from '../components/SubmitVotesTab.astro';
import HistoryTab from '../components/HistoryTab.astro';
import CalculateSeatsTab from '../components/CalculateSeatsTab.astro';
import ClearSubmissionsTab from '../components/ClearSubmissionsTab.astro';
import CalculationResults from '../components/CalculationResults.astro';
import TabSwitchingScript from '../components/TabSwitchingScript.astro';
import { DhondtApiService } from '../services/api';
import { PREDEFINED_PARTIES, TABS, FORM_ACTIONS, type TabType } from '../utils/constants';
import type { ListInput, CalculationHistoryItem, CalculationResult } from '../types/dhondt';

// State variables
let submitResult = null;
let aggregateResult: CalculationResult | null = null;
let aggregatedVotes = null;
let calculationHistory: CalculationHistoryItem[] | null = null;
let error = null;
let successMessage = null;
let activeTab: TabType = TABS.SUBMIT; // Default active tab

// Get backend URL for components
const backendUrl = import.meta.env.PUBLIC_BACKEND_URL || 'http://localhost:5000';

// Handle form submissions
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action') as string;

    if (action === FORM_ACTIONS.SUBMIT_VOTES) {
      // Submit votes to database for aggregation
      const lists: ListInput[] = [];

      // Iterate through predefined parties
      for (const partyName of PREDEFINED_PARTIES) {
        const votes = formData.get(`party_${partyName}`) as string;

        if (votes && parseInt(votes) > 0) {
          lists.push({
            name: partyName,
            votes: parseInt(votes)
          });
        }
      }

      if (lists.length === 0) {
        error = 'Por favor ingrese al menos una lista con votos';
      } else {
        submitResult = await DhondtApiService.submitVotes(lists);
        successMessage = submitResult.message;

        // Fetch updated aggregated votes
        aggregatedVotes = await DhondtApiService.getAggregatedVotes();

        // Switch to aggregated votes tab after successful submission
        activeTab = TABS.HISTORY;
      }
    } else if (action === FORM_ACTIONS.CALCULATE_AGGREGATE) {
      // Calculate D'Hondt on aggregate data
      const totalSeats = parseInt(formData.get('totalSeats') as string);

      if (totalSeats <= 0) {
        error = 'El total de escaños debe ser mayor que 0';
        activeTab = TABS.CALCULATE;
      } else {
        aggregateResult = await DhondtApiService.calculateAggregate(totalSeats, true);
        successMessage = 'Cálculo completado exitosamente';
        activeTab = TABS.CALCULATE;

        // Refresh calculation history after successful calculation
        try {
          calculationHistory = await DhondtApiService.getCalculationHistory();
        } catch (e: any) {
          console.error('Failed to refresh calculation history:', e.message);
        }
      }
    } else if (action === FORM_ACTIONS.CLEAR_SUBMISSIONS) {
      // Clear all submissions
      const clearResult = await DhondtApiService.clearSubmissions();
      successMessage = clearResult.message;
      aggregatedVotes = null;
      activeTab = TABS.CLEAR;
    }
  } catch (e: any) {
    error = `Error: ${e.message}`;
  }
}

// Load aggregated votes on initial page load (if not already loaded)
if (!aggregatedVotes && !error) {
  try {
    aggregatedVotes = await DhondtApiService.getAggregatedVotes();
  } catch (e: any) {
    // It's OK if there are no submissions yet
    if (!e.message.includes('No voting submissions')) {
      console.error('Failed to load aggregated votes:', e.message);
    }
  }
}

// Load calculation history on initial page load
if (!calculationHistory && !error) {
  try {
    calculationHistory = await DhondtApiService.getCalculationHistory();
  } catch (e: any) {
    // It's OK if there are no calculations yet
    console.error('Failed to load calculation history:', e.message);
  }
}
---

<Layout title="Calculadora D'Hondt - Votación Agregada">

  <MessageBanner error={error} successMessage={successMessage} />

  {/* Tab Navigation and Content */}
  <div class="tabs-container">
    <TabNavigation activeTab={activeTab} />

    <div class="tabs-content">
      <SubmitVotesTab
        isActive={activeTab === TABS.SUBMIT}
        predefinedParties={[...PREDEFINED_PARTIES]}
      />

      <HistoryTab
        isActive={activeTab === TABS.HISTORY}
        aggregatedVotes={aggregatedVotes}
        calculationHistory={calculationHistory}
        backendUrl={backendUrl}
      />

      <CalculateSeatsTab
        isActive={activeTab === TABS.CALCULATE}
        aggregatedVotes={aggregatedVotes}
      />

      <ClearSubmissionsTab
        isActive={activeTab === TABS.CLEAR}
        aggregatedVotes={aggregatedVotes}
      />
    </div>
  </div>

  {/* Modal for Results */}
  <Modal id="resultsModal">
    <div id="modalResults">
      {aggregateResult && <CalculationResults result={aggregateResult} />}
    </div>
  </Modal>

  {/* Chart.js Library */}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  {/* Tab Switching Logic */}
  <TabSwitchingScript />

  {/* Modal Logic */}
  <script is:inline define:vars={{ hasResult: !!aggregateResult }}>
    // Wait for DOM and modal functions to be ready
    function waitForModal() {
      if (typeof window.initModal === 'function' && typeof window.openModal === 'function') {
        // Initialize modal
        window.initModal('resultsModal');

        // Auto-open modal if results exist
        if (hasResult) {
          setTimeout(() => {
            window.openModal('resultsModal');
          }, 100);
        }
      } else {
        // Retry after a short delay if functions not ready yet
        setTimeout(waitForModal, 50);
      }
    }

    // Start waiting for modal functions when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForModal);
    } else {
      // DOM already loaded
      waitForModal();
    }
  </script>

  <style>
    /* Tabs Container */
    .tabs-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    /* Tab Content */
    .tabs-content {
      position: relative;
      min-height: 400px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .tabs-content {
        min-height: 300px;
      }
    }
  </style>
</Layout>
